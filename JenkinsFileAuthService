// ==========================================
// JENKINSFILE PARA AUTH-SERVICE
// ==========================================

pipeline {
    agent any

    tools {
        maven 'Maven'
    }

    triggers {
        githubPush()
    }

    options {
        disableConcurrentBuilds()
        timeout(time: 45, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '15'))
    }

    // üîß PAR√ÅMETROS CONFIGURABLES
    parameters {
        string(
            name: 'SERVICE_NAME',
            defaultValue: 'auth-service',
            description: 'Nombre del microservicio. Por defecto: auth-service'
        )
        string(
            name: 'JAR_NAME',
            defaultValue: '',
            description: 'Nombre del archivo JAR. Si est√° vac√≠o, se detecta autom√°ticamente.'
        )
        string(
            name: 'SERVICE_PATH',
            defaultValue: '',
            description: 'Ruta personalizada en el servidor. Si est√° vac√≠o, usa /home/ubuntu/[SERVICE_NAME]'
        )
        choice(
            name: 'JAVA_VERSION',
            choices: ['17', '21', '11'],
            description: 'Versi√≥n de Java a usar (por defecto: 17 para auth-service)'
        )
        booleanParam(
            name: 'FORCE_DEPLOY',
            defaultValue: false,
            description: 'Forzar deploy incluso en ramas de feature'
        )
    }

    environment {
        // ‚úÖ INICIALIZACI√ìN DE VARIABLES
        BRANCH_NAME = "${env.GIT_BRANCH?.replaceAll('origin/', '') ?: env.BRANCH_NAME ?: 'dev'}"
        ENV = "${env.BRANCH_NAME == 'main' ? 'prod' : env.BRANCH_NAME ?: 'dev'}"

        // Configuraci√≥n de servidores EC2
        EC2_USER = 'ubuntu'
        EC2_IP_DEV = '23.22.115.242'
        EC2_IP_QA = '3.220.122.151'
        EC2_IP_PROD = '34.224.192.38'

        // Credenciales y herramientas
        SSH_KEY = credentials('ssh-key-ec2')
        JDK_DIR = "${WORKSPACE}/jdk${params.JAVA_VERSION ?: '17'}"
        JAVA_HOME = "${WORKSPACE}/jdk${params.JAVA_VERSION ?: '17'}"
        PATH = "${WORKSPACE}/jdk${params.JAVA_VERSION ?: '17'}/bin:${PATH}"

        // ‚úÖ INICIALIZACI√ìN DE VARIABLES CALCULADAS
        CALCULATED_SERVICE_NAME = "${params.SERVICE_NAME ?: 'auth-service'}"
        CALCULATED_JAR_NAME = "${params.SERVICE_NAME ?: 'auth-service'}-0.0.1-SNAPSHOT.jar"
        CALCULATED_SERVICE_PATH = "${params.SERVICE_PATH ?: '/home/ubuntu/auth-service'}"
        DEPLOY_STRATEGY = "compile-only"
        TARGET_ENV = "none"
    }

    stages {
        stage('üîç Auto-Detection & Setup') {
            steps {
                script {
                    echo "üîç [AUTH-SERVICE] Iniciando detecci√≥n autom√°tica..."

                    try {
                        // 1. Detecci√≥n del nombre del servicio
                        if (params.SERVICE_NAME && params.SERVICE_NAME.trim()) {
                            env.CALCULATED_SERVICE_NAME = params.SERVICE_NAME.trim()
                            echo "‚úÖ [AUTH-SERVICE] Nombre del servicio (par√°metro): ${env.CALCULATED_SERVICE_NAME}"
                        } else {
                            echo "üîç [AUTH-SERVICE] Detectando servicio desde pom.xml..."

                            try {
                                def pomDetection = sh(
                                    script: '''
                                        if [ ! -f "pom.xml" ]; then
                                            echo ""
                                            exit 0
                                        fi

                                        # M√©todo simple con grep
                                        ARTIFACT_ID=$(grep -A1 -B1 "<artifactId>" pom.xml | grep -v "parent" | grep -v "spring-boot-starter-parent" | grep "<artifactId>" | head -1 | sed 's/.*<artifactId>//g' | sed 's/<.*//g' | tr -d ' \\t' | head -1)

                                        if [ -n "$ARTIFACT_ID" ] && [ "$ARTIFACT_ID" != "" ]; then
                                            echo "$ARTIFACT_ID"
                                        else
                                            # Fallback m√°s simple
                                            grep "<artifactId>" pom.xml | head -2 | tail -1 | sed 's/.*<artifactId>//g' | sed 's/<.*//g' | tr -d ' \\t' || echo ""
                                        fi
                                    ''',
                                    returnStdout: true
                                ).trim()

                                echo "üîç [AUTH-SERVICE] Detecci√≥n desde pom.xml: '${pomDetection}'"

                                if (pomDetection && pomDetection != "") {
                                    env.CALCULATED_SERVICE_NAME = pomDetection
                                    echo "‚úÖ [AUTH-SERVICE] Servicio detectado desde pom.xml: ${env.CALCULATED_SERVICE_NAME}"
                                } else {
                                    // Fallback: detectar desde clase principal
                                    def classDetection = sh(
                                        script: '''
                                            APP_CLASS=$(find src/main/java -name "*Application.java" 2>/dev/null | head -1 | xargs basename -s .java 2>/dev/null || echo "")
                                            if [ -n "$APP_CLASS" ]; then
                                                echo "$APP_CLASS" | sed 's/Application$//' | tr '[:upper:]' '[:lower:]'
                                            else
                                                echo "auth-service"
                                            fi
                                        ''',
                                        returnStdout: true
                                    ).trim()

                                    env.CALCULATED_SERVICE_NAME = classDetection
                                    echo "‚úÖ [AUTH-SERVICE] Servicio detectado desde clase: ${env.CALCULATED_SERVICE_NAME}"
                                }

                            } catch (Exception e) {
                                echo "‚ö†Ô∏è [AUTH-SERVICE] Error en detecci√≥n autom√°tica: ${e.message}"
                                env.CALCULATED_SERVICE_NAME = "auth-service"
                            }
                        }

                        // ‚úÖ LIMPIAR Y VALIDAR NOMBRE DEL SERVICIO
                        if (env.CALCULATED_SERVICE_NAME && env.CALCULATED_SERVICE_NAME != "") {
                            env.CALCULATED_SERVICE_NAME = env.CALCULATED_SERVICE_NAME.replaceAll('[^a-zA-Z0-9-_]', '-').toLowerCase()
                            if (env.CALCULATED_SERVICE_NAME.length() > 50) {
                                env.CALCULATED_SERVICE_NAME = env.CALCULATED_SERVICE_NAME.substring(0, 50)
                            }
                            if (env.CALCULATED_SERVICE_NAME.startsWith("-")) {
                                env.CALCULATED_SERVICE_NAME = env.CALCULATED_SERVICE_NAME.substring(1)
                            }
                            if (env.CALCULATED_SERVICE_NAME.endsWith("-")) {
                                env.CALCULATED_SERVICE_NAME = env.CALCULATED_SERVICE_NAME.substring(0, env.CALCULATED_SERVICE_NAME.length() - 1)
                            }
                            if (env.CALCULATED_SERVICE_NAME == "" || env.CALCULATED_SERVICE_NAME == "-") {
                                env.CALCULATED_SERVICE_NAME = "auth-service"
                            }
                        } else {
                            env.CALCULATED_SERVICE_NAME = "auth-service"
                        }

                        echo "‚úÖ [AUTH-SERVICE] Nombre final del servicio: ${env.CALCULATED_SERVICE_NAME}"

                        // 2. Calcular nombre del JAR
                        if (params.JAR_NAME && params.JAR_NAME.trim()) {
                            env.CALCULATED_JAR_NAME = params.JAR_NAME.trim()
                        } else {
                            env.CALCULATED_JAR_NAME = "${env.CALCULATED_SERVICE_NAME}-0.0.1-SNAPSHOT.jar"
                        }
                        echo "üì¶ [AUTH-SERVICE] JAR esperado: ${env.CALCULATED_JAR_NAME}"

                        // 3. Calcular ruta del servicio
                        if (params.SERVICE_PATH && params.SERVICE_PATH.trim()) {
                            env.CALCULATED_SERVICE_PATH = params.SERVICE_PATH.trim()
                        } else {
                            env.CALCULATED_SERVICE_PATH = "/home/ubuntu/${env.CALCULATED_SERVICE_NAME}"
                        }
                        echo "üìÅ [AUTH-SERVICE] Ruta del servicio: ${env.CALCULATED_SERVICE_PATH}"

                        // 4. Validaci√≥n de estructura
                        echo "üîç [AUTH-SERVICE] Validando estructura del proyecto..."
                        try {
                            def pomExists = sh(
                                script: "[ -f pom.xml ] && echo 'true' || echo 'false'",
                                returnStdout: true
                            ).trim()

                            def mainClassCount = sh(
                                script: "find src/main/java -name '*Application.java' 2>/dev/null | wc -l || echo '0'",
                                returnStdout: true
                            ).trim()

                            echo "‚úÖ [AUTH-SERVICE] pom.xml existe: ${pomExists}"
                            echo "‚úÖ [AUTH-SERVICE] Clases *Application.java encontradas: ${mainClassCount}"

                        } catch (Exception e) {
                            echo "‚ö†Ô∏è [AUTH-SERVICE] Error validando estructura: ${e.message}"
                        }

                        // 5. ‚úÖ DETERMINAR ESTRATEGIA DE DEPLOY
                        def currentBranch = env.BRANCH_NAME ?: 'dev'
                        echo "üîç [AUTH-SERVICE] Rama actual: ${currentBranch}"
                        echo "üîç [AUTH-SERVICE] Par√°metro FORCE_DEPLOY: ${params.FORCE_DEPLOY}"

                        if (params.FORCE_DEPLOY == true) {
                            echo "üöÄ [AUTH-SERVICE] ESTRATEGIA: Deploy forzado"
                            env.DEPLOY_STRATEGY = 'auto'
                            env.TARGET_ENV = (currentBranch == 'main') ? 'prod' : (currentBranch == 'qa') ? 'qa' : 'dev'
                        } else if (currentBranch == 'dev') {
                            echo "üöÄ [AUTH-SERVICE] ESTRATEGIA: Deploy autom√°tico a DEV"
                            env.DEPLOY_STRATEGY = 'auto'
                            env.TARGET_ENV = 'dev'
                        } else if (currentBranch == 'qa') {
                            echo "üîÑ [AUTH-SERVICE] ESTRATEGIA: Deploy autom√°tico a QA"
                            env.DEPLOY_STRATEGY = 'auto'
                            env.TARGET_ENV = 'qa'
                        } else if (currentBranch == 'main') {
                            echo "‚ö†Ô∏è [AUTH-SERVICE] ESTRATEGIA: Aprobaci√≥n manual + Deploy a PROD"
                            env.DEPLOY_STRATEGY = 'manual-approval'
                            env.TARGET_ENV = 'prod'
                        } else {
                            echo "‚úèÔ∏è [AUTH-SERVICE] ESTRATEGIA: Solo compilaci√≥n (rama: ${currentBranch})"
                            env.DEPLOY_STRATEGY = 'compile-only'
                            env.TARGET_ENV = 'none'
                        }

                        echo """
üéØ [AUTH-SERVICE] CONFIGURACI√ìN FINAL:
   ‚Ä¢ Servicio: ${env.CALCULATED_SERVICE_NAME}
   ‚Ä¢ JAR: ${env.CALCULATED_JAR_NAME}
   ‚Ä¢ Ruta: ${env.CALCULATED_SERVICE_PATH}
   ‚Ä¢ Rama: ${currentBranch}
   ‚Ä¢ Entorno: ${env.TARGET_ENV}
   ‚Ä¢ Estrategia: ${env.DEPLOY_STRATEGY}
   ‚Ä¢ Java: ${params.JAVA_VERSION ?: '17'}
   ‚Ä¢ Tests: DESHABILITADOS (solo compilaci√≥n y deploy)
   ‚Ä¢ Puerto: Configurado en Config Server
"""

                    } catch (Exception e) {
                        echo "‚ùå [AUTH-SERVICE] Error cr√≠tico en configuraci√≥n: ${e.message}"
                        e.printStackTrace()

                        // ‚úÖ CONFIGURACI√ìN DE EMERGENCIA
                        env.CALCULATED_SERVICE_NAME = "auth-service"
                        env.CALCULATED_JAR_NAME = "auth-service-0.0.1-SNAPSHOT.jar"
                        env.CALCULATED_SERVICE_PATH = "/home/ubuntu/auth-service"
                        env.DEPLOY_STRATEGY = "compile-only"
                        env.TARGET_ENV = "none"

                        echo "üÜò [AUTH-SERVICE] Usando configuraci√≥n de emergencia"
                        error("Error en configuraci√≥n inicial")
                    }
                }
            }
        }

        stage('üîß Setup JDK') {
            when {
                not { environment name: 'DEPLOY_STRATEGY', value: 'skip' }
            }
            steps {
                script {
                    def javaVersion = params.JAVA_VERSION ?: '17'
                    def downloadUrl = ""

                    switch(javaVersion) {
                        case '21':
                            downloadUrl = "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.2%2B13/OpenJDK21U-jdk_x64_linux_hotspot_21.0.2_13.tar.gz"
                            break
                        case '17':
                            downloadUrl = "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.9%2B9/OpenJDK17U-jdk_x64_linux_hotspot_17.0.9_9.tar.gz"
                            break
                        case '11':
                            downloadUrl = "https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jdk_x64_linux_hotspot_11.0.21_9.tar.gz"
                            break
                        default:
                            downloadUrl = "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.9%2B9/OpenJDK17U-jdk_x64_linux_hotspot_17.0.9_9.tar.gz"
                    }

                    echo "üîß [AUTH-SERVICE] Configurando JDK ${javaVersion}..."
                    sh """
                        mkdir -p \${JDK_DIR}

                        if [ ! -f \${JDK_DIR}/bin/java ]; then
                            echo "üì• [AUTH-SERVICE] Descargando JDK ${javaVersion}..."
                            wget -q "${downloadUrl}" -O jdk.tar.gz
                            tar -xzf jdk.tar.gz -C \${JDK_DIR} --strip-components=1
                            rm jdk.tar.gz
                            echo "‚úÖ [AUTH-SERVICE] JDK ${javaVersion} instalado"
                        else
                            echo "‚úÖ [AUTH-SERVICE] JDK ${javaVersion} ya existe"
                        fi

                        echo "‚òï [AUTH-SERVICE] Java version:"
                        \${JDK_DIR}/bin/java -version
                    """
                }
            }
        }

        stage('üî® Build Application') {
            when {
                not { environment name: 'DEPLOY_STRATEGY', value: 'skip' }
            }
            steps {
                sh """
                    export JAVA_HOME=\${JDK_DIR}
                    export PATH=\${JAVA_HOME}/bin:\$PATH

                    echo "üî® [AUTH-SERVICE] Compilando aplicaci√≥n SIN TESTS..."

                    # Dar permisos de ejecuci√≥n a mvnw
                    chmod +x ./mvnw

                    # COMPILACI√ìN SIMPLE - NO TESTS, NO JACOCO, NO PROBLEMAS
                    echo "üîß [AUTH-SERVICE] Configuraci√≥n: Sin tests, sin JaCoCo, solo JAR"

                    # Flags para deshabilitar todo lo problem√°tico
                    MAVEN_FLAGS="-DskipTests -Dmaven.test.skip=true -Djacoco.skip=true -Dcheckstyle.skip=true -Dspotbugs.skip=true -Dflyway.skip=true -Dspring.profiles.active="

                    echo "üìù Compilando con flags: \$MAVEN_FLAGS"

                    if ./mvnw clean package \$MAVEN_FLAGS -q; then
                        echo "‚úÖ Compilaci√≥n exitosa sin tests"
                    else
                        echo "‚ö†Ô∏è Compilaci√≥n fall√≥, intentando con configuraci√≥n m√°s agresiva..."

                        # Fallback 1: Con configuraci√≥n offline
                        if ./mvnw clean package \$MAVEN_FLAGS -o -q; then
                            echo "‚úÖ Compilaci√≥n exitosa con configuraci√≥n offline"
                        else
                            echo "‚ö†Ô∏è Fallback offline fall√≥, intentando sin perfiles..."
                            # Fallback 2: Sin perfiles y sin config server
                            if ./mvnw clean package -DskipTests -Dmaven.test.skip=true -q; then
                                echo "‚úÖ Compilaci√≥n exitosa con configuraci√≥n m√≠nima"
                            else
                                echo "‚ùå Compilaci√≥n fall√≥. Mostrando errores:"
                                ./mvnw clean package -DskipTests 2>&1 | tail -20
                                exit 1
                            fi
                        fi
                    fi

                    # ‚úÖ DETECCI√ìN SEGURA DEL JAR Y NOMBRE REAL DEL SERVICIO
                    echo "üîç Buscando JAR compilado y actualizando nombre del servicio..."
                    JAR_FILE=\$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)

                    if [ -n "\$JAR_FILE" ] && [ -s "\$JAR_FILE" ]; then
                        echo "‚úÖ [AUTH-SERVICE] JAR encontrado: \$JAR_FILE"
                        echo "üìä Tama√±o: \$(du -h "\$JAR_FILE" | cut -f1)"
                        ls -lh "\$JAR_FILE"

                        # Extraer nombre real del servicio desde el JAR de forma segura
                        JAR_NAME=\$(basename "\$JAR_FILE")
                        REAL_SERVICE_NAME=\$(echo "\$JAR_NAME" | cut -d'-' -f1)

                        echo "JAR_FOUND=\$JAR_NAME" > jar_info.txt
                        echo "REAL_SERVICE_NAME=\$REAL_SERVICE_NAME" >> jar_info.txt
                        echo "‚úÖ JAR listo para deploy"
                        echo "üîÑ Nombre real del servicio detectado: \$REAL_SERVICE_NAME"
                    else
                        echo "‚ùå [AUTH-SERVICE] No se encontr√≥ JAR v√°lido"
                        echo "üîç Contenido de target/:"
                        ls -la target/ 2>/dev/null || echo "Directorio target no existe"
                        exit 1
                    fi
                """

                script {
                    // ‚úÖ ACTUALIZAR VARIABLES CON EL SERVICIO REAL
                    try {
                        if (fileExists('jar_info.txt')) {
                            def jarInfo = readFile('jar_info.txt').trim()
                            def lines = jarInfo.split('\n')

                            for (line in lines) {
                                if (line.contains('JAR_FOUND=')) {
                                    def foundJarName = line.split('=')[1]
                                    if (foundJarName && foundJarName != "") {
                                        env.CALCULATED_JAR_NAME = foundJarName
                                        echo "‚úÖ [SETUP] JAR final detectado: ${env.CALCULATED_JAR_NAME}"
                                    }
                                }
                                if (line.contains('REAL_SERVICE_NAME=')) {
                                    def realServiceName = line.split('=')[1]
                                    if (realServiceName && realServiceName != "" && realServiceName != "null") {
                                        env.CALCULATED_SERVICE_NAME = realServiceName
                                        env.CALCULATED_SERVICE_PATH = "/home/ubuntu/${realServiceName}"
                                        echo "üîÑ [SETUP] Nombre del servicio actualizado: ${env.CALCULATED_SERVICE_NAME}"
                                        echo "üîÑ [SETUP] Ruta actualizada: ${env.CALCULATED_SERVICE_PATH}"
                                    }
                                }
                            }
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è [SETUP] Error leyendo jar_info.txt: ${e.message}"
                    }
                }
            }
        }

        stage('‚ö†Ô∏è Production Approval') {
            when {
                environment name: 'DEPLOY_STRATEGY', value: 'manual-approval'
            }
            steps {
                script {
                    def branchName = env.BRANCH_NAME ?: 'unknown'
                    def buildNumber = env.BUILD_NUMBER ?: 'N/A'
                    def javaVersion = params.JAVA_VERSION ?: '17'

                    echo """
üö® [AUTH-SERVICE] APROBACI√ìN REQUERIDA PARA PRODUCCI√ìN

üìã Informaci√≥n del Deploy:
   ‚Ä¢ Servicio: ${env.CALCULATED_SERVICE_NAME}
   ‚Ä¢ Entorno: PRODUCCI√ìN
   ‚Ä¢ Rama: ${branchName}
   ‚Ä¢ Build: ${buildNumber}
   ‚Ä¢ Java: ${javaVersion}
   ‚Ä¢ Compilaci√≥n: SIN TESTS (solo JAR)
   ‚Ä¢ Puerto: Definido en Config Server
"""

                    timeout(time: 15, unit: 'MINUTES') {
                        def approvalResponse = input(
                            message: "üö® ¬øAprobar deploy de ${env.CALCULATED_SERVICE_NAME} a PRODUCCI√ìN?",
                            ok: '‚úÖ Aprobar Deploy',
                            parameters: [
                                choice(
                                    name: 'ACTION',
                                    choices: ['Aprobar', 'Rechazar'],
                                    description: 'Selecciona la acci√≥n'
                                ),
                                text(
                                    name: 'COMMENTS',
                                    defaultValue: '',
                                    description: 'Comentarios adicionales (opcional)'
                                )
                            ]
                        )

                        if (approvalResponse.ACTION != 'Aprobar') {
                            error("‚ùå [AUTH-SERVICE] Deploy a producci√≥n rechazado")
                        }

                        echo "‚úÖ [AUTH-SERVICE] Deploy a producci√≥n APROBADO"
                        if (approvalResponse.COMMENTS?.trim()) {
                            echo "üí¨ Comentarios: ${approvalResponse.COMMENTS}"
                        }
                    }
                }
            }
        }

        stage('üöÄ Deploy Auth Service') {
            when {
                anyOf {
                    environment name: 'DEPLOY_STRATEGY', value: 'auto'
                    environment name: 'DEPLOY_STRATEGY', value: 'manual-approval'
                }
            }
            steps {
                script {
                    def EC2_IP = ''
                    def cleanServiceName = env.CALCULATED_SERVICE_NAME.replaceAll('[^a-zA-Z0-9-_]', '-')
                    def targetEnv = env.TARGET_ENV ?: 'dev'
                    def envProfile = env.ENV ?: 'dev'

                    // Determinar IP seg√∫n entorno
                    if (targetEnv == 'prod') {
                        EC2_IP = env.EC2_IP_PROD
                    } else if (targetEnv == 'qa') {
                        EC2_IP = env.EC2_IP_QA
                    } else {
                        EC2_IP = env.EC2_IP_DEV
                    }

                    echo "üöÄ [AUTH-SERVICE] Desplegando en ${targetEnv.toUpperCase()} (${EC2_IP})"

                    // 1. Preparar servidor
                    sh """
                    echo "üîß [AUTH-SERVICE] Preparando servidor..."
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${EC2_USER}@${EC2_IP} '
                        # Crear directorios
                        sudo mkdir -p ${env.CALCULATED_SERVICE_PATH}
                        sudo chown -R ubuntu:ubuntu ${env.CALCULATED_SERVICE_PATH}

                        # Instalar dependencias b√°sicas
                        which curl > /dev/null || sudo apt-get update -qq && sudo apt-get install -y curl
                        which netstat > /dev/null || sudo apt-get install -y net-tools

                        # Instalar Java si no existe
                        if ! which java > /dev/null; then
                            echo "‚òï [AUTH-SERVICE] Instalando Java ${params.JAVA_VERSION ?: '17'}..."
                            sudo apt-get update -qq && sudo apt-get install -y openjdk-${params.JAVA_VERSION ?: '17'}-jre-headless
                        fi

                        echo "‚úÖ [AUTH-SERVICE] Servidor preparado"
                    '
                    """

                    // 2. Detener servicio existente
                    sh """
                    echo "üõë [AUTH-SERVICE] Deteniendo servicio existente..."
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        if sudo systemctl is-active --quiet ${cleanServiceName}.service 2>/dev/null; then
                            echo "üõë Deteniendo servicio ${cleanServiceName}..."
                            sudo systemctl stop ${cleanServiceName}.service
                            sleep 5
                        else
                            echo "‚ÑπÔ∏è Servicio ${cleanServiceName} no est√° corriendo"
                        fi
                    ' || echo "‚ö†Ô∏è [AUTH-SERVICE] No hay servicio previo"
                    """

                    // 3. Copiar JAR
                    sh """
                    echo "üì¶ [AUTH-SERVICE] Copiando JAR..."

                    # Buscar el JAR compilado din√°micamente
                    JAR_FILE=\$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)

                    if [ -n "\$JAR_FILE" ]; then
                        echo "üì¶ Copiando JAR: \$JAR_FILE"
                        scp -i \$SSH_KEY -o StrictHostKeyChecking=no "\$JAR_FILE" ${EC2_USER}@${EC2_IP}:${env.CALCULATED_SERVICE_PATH}/app.jar
                        echo "‚úÖ [AUTH-SERVICE] JAR copiado como app.jar"
                    else
                        echo "‚ùå No se encontr√≥ JAR para copiar"
                        exit 1
                    fi
                    """

                    // 4. Crear servicio systemd para auth-service
                    def systemdService = """[Unit]
Description=Spring Boot Auth Service
After=network.target
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=${env.CALCULATED_SERVICE_PATH}
ExecStart=/usr/bin/java -jar ${env.CALCULATED_SERVICE_PATH}/app.jar \\
    --spring.profiles.active=${envProfile} \\
    --logging.level.root=INFO \\
    --logging.file.name=${env.CALCULATED_SERVICE_PATH}/${cleanServiceName}.log

# Configuraci√≥n de reinicio
Restart=on-failure
RestartSec=10
SuccessExitStatus=143

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=${cleanServiceName}

# Seguridad
NoNewPrivileges=true
PrivateTmp=true

# Variables de entorno
Environment=JAVA_HOME=/usr/lib/jvm/java-${params.JAVA_VERSION ?: '17'}-openjdk-amd64
Environment=SPRING_PROFILES_ACTIVE=${envProfile}

[Install]
WantedBy=multi-user.target"""

                    // 5. Configurar e iniciar servicio
                    sh """
                    echo "‚öôÔ∏è [AUTH-SERVICE] Configurando servicio systemd..."

                    # Crear archivo de servicio
                    echo '${systemdService}' | ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} 'sudo tee /etc/systemd/system/${cleanServiceName}.service > /dev/null'

                    # Configurar e iniciar servicio
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        # Recargar systemd
                        sudo systemctl daemon-reload

                        # Habilitar auto-inicio
                        sudo systemctl enable ${cleanServiceName}.service

                        # Iniciar servicio
                        sudo systemctl start ${cleanServiceName}.service

                        # Verificar inicio
                        sleep 15
                        if sudo systemctl is-active --quiet ${cleanServiceName}.service; then
                            echo "‚úÖ [AUTH-SERVICE] Servicio iniciado correctamente"
                            sudo systemctl status ${cleanServiceName}.service --no-pager -l
                        else
                            echo "‚ùå [AUTH-SERVICE] Error al iniciar servicio"
                            sudo systemctl status ${cleanServiceName}.service --no-pager -l
                            sudo journalctl -u ${cleanServiceName}.service --since \"5 minutes ago\" --no-pager
                            exit 1
                        fi
                    '
                    """

                    echo "‚úÖ [AUTH-SERVICE] Deploy completado en ${targetEnv.toUpperCase()}!"
                }
            }
        }

        stage('üîç Health Check & Verification') {
            when {
                anyOf {
                    environment name: 'DEPLOY_STRATEGY', value: 'auto'
                    environment name: 'DEPLOY_STRATEGY', value: 'manual-approval'
                }
            }
            steps {
                script {
                    def EC2_IP = ''
                    def cleanServiceName = env.CALCULATED_SERVICE_NAME.replaceAll('[^a-zA-Z0-9-_]', '-')

                    if (env.TARGET_ENV == 'prod') {
                        EC2_IP = env.EC2_IP_PROD
                    } else if (env.TARGET_ENV == 'qa') {
                        EC2_IP = env.EC2_IP_QA
                    } else {
                        EC2_IP = env.EC2_IP_DEV
                    }

                    echo "üîç [AUTH-SERVICE] Verificando deploy..."

                    // Esperar inicio completo
                    sh "sleep 45"

                    // Verificaciones completas
                    sh """
                    ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                        echo "üìä [AUTH-SERVICE] Estado del servicio:"
                        sudo systemctl status ${cleanServiceName}.service --no-pager

                        echo "üîå [AUTH-SERVICE] Detectando puerto del servicio..."
                        # Detectar el puerto que est√° usando el servicio
                        SERVICE_PORT=\$(sudo journalctl -u ${cleanServiceName}.service --since \"10 minutes ago\" --no-pager | grep -o "Tomcat started on port(s): [0-9]*" | grep -o "[0-9]*" | tail -1)

                        if [ -z "\$SERVICE_PORT" ]; then
                            # Fallback: buscar cualquier puerto que est√© escuchando el proceso Java
                            SERVICE_PID=\$(sudo systemctl show --property MainPID --value ${cleanServiceName}.service)
                            if [ "\$SERVICE_PID" != "0" ] && [ -n "\$SERVICE_PID" ]; then
                                SERVICE_PORT=\$(sudo netstat -tlnp 2>/dev/null | grep "\$SERVICE_PID/java" | awk "{print \$4}" | cut -d: -f2 | head -1)
                            fi
                        fi

                        if [ -n "\$SERVICE_PORT" ]; then
                            echo "‚úÖ Puerto detectado: \$SERVICE_PORT"

                            echo "üè• [AUTH-SERVICE] Verificando health endpoint..."
                            for i in {1..15}; do
                                if curl -f http://localhost:\$SERVICE_PORT/actuator/health 2>/dev/null; then
                                    echo "‚úÖ Health Check: PASSED"
                                    curl -s http://localhost:\$SERVICE_PORT/actuator/health | head -5
                                    break
                                fi
                                echo "‚è≥ Esperando health endpoint... (\$i/15)"
                                sleep 10
                            done

                            echo "üåê [AUTH-SERVICE] Verificando endpoints importantes..."
                            # Verificar swagger
                            curl -s http://localhost:\$SERVICE_PORT/v3/api-docs 2>/dev/null | grep -q "openapi" && \
                                echo "‚úÖ Swagger disponible" || echo "‚ö†Ô∏è Swagger no disponible"

                            # Verificar auth endpoints
                            curl -s http://localhost:\$SERVICE_PORT/auth/authenticate -o /dev/null -w "Auth Endpoints: %{http_code}\\n"
                        else
                            echo "‚ö†Ô∏è No se pudo detectar el puerto del servicio"
                            echo "üîç Puertos activos:"
                            sudo netstat -tuln | grep LISTEN
                        fi

                        echo "üìÑ [AUTH-SERVICE] √öltimos logs del servicio:"
                        sudo journalctl -u ${cleanServiceName}.service --since \"5 minutes ago\" --no-pager | tail -20

                        echo "‚úÖ [AUTH-SERVICE] Verificaci√≥n completada"
                    '
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                def deployStrategy = env.DEPLOY_STRATEGY ?: 'N/A'
                def branchName = env.BRANCH_NAME ?: 'unknown'
                def targetEnv = env.TARGET_ENV ?: 'unknown'

                if (deployStrategy && deployStrategy != 'compile-only') {
                    def EC2_IP = ''
                    def cleanServiceName = env.CALCULATED_SERVICE_NAME.replaceAll('[^a-zA-Z0-9-_]', '-')

                    if (targetEnv == 'prod') {
                        EC2_IP = env.EC2_IP_PROD
                    } else if (targetEnv == 'qa') {
                        EC2_IP = env.EC2_IP_QA
                    } else {
                        EC2_IP = env.EC2_IP_DEV
                    }

                    echo """
üéâ [AUTH-SERVICE] ¬°DEPLOY EXITOSO EN ${targetEnv.toUpperCase()}!

üìã Informaci√≥n del servicio:
   ‚Ä¢ Nombre: ${env.CALCULATED_SERVICE_NAME}
   ‚Ä¢ Servidor: ${EC2_IP}
   ‚Ä¢ Systemd Service: ${cleanServiceName}.service
   ‚Ä¢ Java Version: ${params.JAVA_VERSION ?: '17'}
   ‚Ä¢ Compilaci√≥n: SIN TESTS (solo JAR optimizado)
   ‚Ä¢ Puerto: Configurado en Config Server

üåê API Endpoints:
   ‚Ä¢ Base URL: http://${EC2_IP}:[PUERTO]
   ‚Ä¢ Auth: http://${EC2_IP}:[PUERTO]/auth/authenticate
   ‚Ä¢ Swagger: http://${EC2_IP}:[PUERTO]/swagger-ui/index.html
   ‚Ä¢ Health: http://${EC2_IP}:[PUERTO]/actuator/health

üõ†Ô∏è Comandos de gesti√≥n:
   ‚Ä¢ Estado: sudo systemctl status ${cleanServiceName}.service
   ‚Ä¢ Logs: sudo journalctl -u ${cleanServiceName}.service -f
   ‚Ä¢ Restart: sudo systemctl restart ${cleanServiceName}.service
   ‚Ä¢ Stop: sudo systemctl stop ${cleanServiceName}.service
   ‚Ä¢ Detectar puerto: sudo journalctl -u ${cleanServiceName}.service | grep "Tomcat started on port"

‚úÖ Auto-inicio habilitado
"""
                } else {
                    echo "‚úÖ [AUTH-SERVICE] Compilaci√≥n exitosa SIN TESTS - Rama: ${branchName}"
                }
            }
        }

        failure {
            script {
                def deployStrategy = env.DEPLOY_STRATEGY ?: 'N/A'
                def branchName = env.BRANCH_NAME ?: 'unknown'
                def buildNumber = env.BUILD_NUMBER ?: 'N/A'
                def cleanServiceName = env.CALCULATED_SERVICE_NAME.replaceAll('[^a-zA-Z0-9-_]', '-')

                echo """
‚ùå [AUTH-SERVICE] PIPELINE FALLIDO

üîç Informaci√≥n:
   ‚Ä¢ Servicio: ${env.CALCULATED_SERVICE_NAME}
   ‚Ä¢ Rama: ${branchName}
   ‚Ä¢ Estrategia: ${deployStrategy}
   ‚Ä¢ Build: ${buildNumber}

üõ†Ô∏è Comandos para debug:
   ‚Ä¢ Ver logs: sudo journalctl -u ${cleanServiceName}.service
   ‚Ä¢ Estado: sudo systemctl status ${cleanServiceName}.service
"""
            }
        }

        cleanup {
            sh '''
                rm -rf jdk*.tar.gz jdk.tar.gz jar_info.txt || true
                echo "‚úÖ Limpieza completada"
            '''
        }
    }
}